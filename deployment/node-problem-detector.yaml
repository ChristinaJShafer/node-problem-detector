apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: node-problem-detector
  namespace: kube-system
  labels:
    app: node-problem-detector
spec:
  selector:
    matchLabels:
      app: node-problem-detector
  template:
    metadata:
      labels:
        app: node-problem-detector
    spec:
      hostIPC: True
      #hostNetwork: True
      initContainers:
      - name: imds-iptables
        image: soarinferret/iptablesproxy
        imagePullPolicy: Always
        securityContext:
          capabilities:
            add:
            - NET_ADMIN
            - NET_RAW
            drop:
            - ALL
          privileged: True
        command:
          - sh
          - -c
          - | 
            #! /bin/sh
            set -eux
            iptables -t nat -A OUTPUT -p tcp -d 169.254.169.254 --dport 80 -j DNAT --to-destination 127.0.0.1:5000
            # not sure if prerouting is required but w.e
            iptables -t nat -A PREROUTING -p tcp -d 169.254.169.254 --dport 80 -j DNAT --to-destination 127.0.0.1:5000
            echo "done setting iptables rules" 

      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: kubernetes.io/os
                    operator: In
                    values:
                      - linux
      containers:
      - name: imds-emulator
        image: cljshafer/imds_emulator:latest
        imagePullPolicy: Always
        command:
        - "python3"
        - "/fakeIMDS/app/main.py"
        ports:
        - containerPort: 5000
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        volumeMounts:
        - name: app
          mountPath: /fakeIMDS/app
          readOnly: false
      - name: node-problem-detector
        command:
        - /node-problem-detector
        - --logtostderr
        - --config.system-log-monitor=/config/kernel-monitor.json #,/config/docker-monitor.json
        #- --config.custom-plugin-monitor=config/custom-scheduledevents-preempt-plugin-monitor.json
        - --config.custom-plugin-monitor=config/custom-scheduledevents-plugin-monitor.json,config/custom-scheduledevents-preempt-plugin-monitor.json
        #image: k8s.gcr.io/node-problem-detector/node-problem-detector:v0.8.7
        image: cljshafer/node-problem-detector:v0.8.8-14-g70c919e-dirty
        resources:
          limits:
            cpu: 10m
            memory: 80Mi
          requests:
            cpu: 10m
            memory: 80Mi
        imagePullPolicy: Always
        securityContext:
          privileged: true
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        volumeMounts:
        - name: log
          mountPath: /var/log
          readOnly: true
        - name: kmsg
          mountPath: /dev/kmsg
          readOnly: true
        # Make sure node problem detector is in the same timezone
        # with the host.
        - name: localtime
          mountPath: /etc/localtime
          readOnly: true
        - name: config
          mountPath: /config
          readOnly: false
        - name: config-plugin
          mountPath: /config/plugin
          readOnly: false
        

      volumes:
      - name: log
        # Config `log` to your system log directory
        hostPath:
          path: /var/log/
      - name: kmsg
        hostPath:
          path: /dev/kmsg
      - name: localtime
        hostPath:
          path: /etc/localtime
      - name: config
        configMap:
          name: node-problem-detector-config
          items:
          - key: kernel-monitor.json
            path: kernel-monitor.json
          - key: docker-monitor.json
            path: docker-monitor.json
          - key: custom-scheduledevents-plugin-monitor.json
            path: custom-scheduledevents-plugin-monitor.json
          - key: custom-scheduledevents-preempt-plugin-monitor.json
            path: custom-scheduledevents-preempt-plugin-monitor.json
      - name: config-plugin
        configMap:
          name: node-problem-detector-config
          defaultMode: 0777
          items:
          - key: check_scheduledevent.sh
            path: check_scheduledevent.sh
          - key: check_freeze.sh
            path: check_freeze.sh
          - key: check_preempt.sh
            path: check_preempt.sh
          - key: check_reboot.sh
            path: check_reboot.sh
          - key: check_redeploy.sh
            path: check_redeploy.sh
          - key: check_terminate.sh
            path: check_terminate.sh
      - name: app
        configMap:
          name: node-problem-detector-config
          defaultMode: 0777
          items:
          - key: fakedata.yaml
            path: fakedata.yaml
          - key: main.py
            path: main.py       

      tolerations:
        - effect: NoSchedule
          operator: Exists
        - effect: NoExecute
          operator: Exists
